# ========================================
# Fußbodenheizung Multi-Raum Steuerung
# ========================================
# Komplettes Package für Home Assistant
# Inkludieren in configuration.yaml mit:
# homeassistant:
#   packages:
#     fussboden: !include packages/fussboden_heizung.yaml

# ========================================
# Input Number Helper
# ========================================
input_number:
  # Globale Einstellungen
  fussboden_hysterese:
    name: Fußbodenheizung Hysterese
    min: 0
    max: 2
    step: 0.1
    initial: 1.0
    unit_of_measurement: °C
    icon: mdi:thermometer-lines
    mode: slider
  
  # Pro Raum - Solltemperaturen
  fussboden_bad_solltemperatur:
    name: Bad Solltemperatur
    min: 6
    max: 28
    step: 0.5
    unit_of_measurement: °C
    icon: mdi:thermometer
    mode: slider
  
  fussboden_buro_solltemperatur:
    name: Büro Solltemperatur
    min: 6
    max: 28
    step: 0.5
    unit_of_measurement: °C
    icon: mdi:thermometer
    mode: slider
  
  fussboden_flur_solltemperatur:
    name: Flur Solltemperatur
    min: 6
    max: 28
    step: 0.5
    unit_of_measurement: °C
    icon: mdi:thermometer
    mode: slider
  
  fussboden_kuche_solltemperatur:
    name: Küche Solltemperatur
    min: 6
    max: 28
    step: 0.5
    unit_of_measurement: °C
    icon: mdi:thermometer
    mode: slider
  
  fussboden_schlafzimmer_solltemperatur:
    name: Schlafzimmer Solltemperatur
    min: 6
    max: 28
    step: 0.5
    unit_of_measurement: °C
    icon: mdi:thermometer
    mode: slider
  
  fussboden_wohnzimmer_solltemperatur:
    name: Wohnzimmer Solltemperatur
    min: 6
    max: 28
    step: 0.5
    unit_of_measurement: °C
    icon: mdi:thermometer
    mode: slider

# ========================================
# Input DateTime Helper
# ========================================
input_datetime:
  fussboden_start_zeit:
    name: Heizung Start Zeit
    has_date: false
    has_time: true
    icon: mdi:clock-start
  
  fussboden_ende_zeit:
    name: Heizung Ende Zeit
    has_date: false
    has_time: true
    icon: mdi:clock-end

# ========================================
# Input Boolean Helper
# ========================================
input_boolean:
  fussboden_zeitsteuerung_aktiv:
    name: Zeitsteuerung aktiviert
    icon: mdi:clock-check
  
  fussboden_anti_verkalkung_aktiv:
    name: Anti-Verkalkung aktiviert
    icon: mdi:shield-refresh
    initial: true
  
  # Heater Status pro Raum (für Generic Thermostat)
  fussboden_bad_heating:
    name: Bad Heizung Status
    initial: false
  
  fussboden_buro_heating:
    name: Büro Heizung Status
    initial: false
  
  fussboden_flur_heating:
    name: Flur Heizung Status
    initial: false
  
  fussboden_kuche_heating:
    name: Küche Heizung Status
    initial: false
  
  fussboden_schlafzimmer_heating:
    name: Schlafzimmer Heizung Status
    initial: false
  
  fussboden_wohnzimmer_heating:
    name: Wohnzimmer Heizung Status
    initial: false

# ========================================
# Input Select Helper
# ========================================
input_select:
  fussboden_bad_temp_sensor:
    name: Bad Temperatursensor
    options:
      - "Externer Sensor"
      - "Thermostat Sensor"
    initial: "Externer Sensor"
    icon: mdi:thermometer
  
  fussboden_buro_temp_sensor:
    name: Büro Temperatursensor
    options:
      - "Externer Sensor"
      - "Thermostat Sensor"
    initial: "Externer Sensor"
    icon: mdi:thermometer
  
  fussboden_flur_temp_sensor:
    name: Flur Temperatursensor
    options:
      - "Externer Sensor"
      - "Thermostat Sensor"
    initial: "Externer Sensor"
    icon: mdi:thermometer
  
  fussboden_kuche_temp_sensor:
    name: Küche Temperatursensor
    options:
      - "Externer Sensor"
      - "Thermostat Sensor"
    initial: "Externer Sensor"
    icon: mdi:thermometer
  
  fussboden_schlafzimmer_temp_sensor:
    name: Schlafzimmer Temperatursensor
    options:
      - "Externer Sensor"
      - "Thermostat Sensor"
    initial: "Externer Sensor"
    icon: mdi:thermometer
  
  fussboden_wohnzimmer_temp_sensor:
    name: Wohnzimmer Temperatursensor
    options:
      - "Externer Sensor"
      - "Thermostat Sensor"
    initial: "Externer Sensor"
    icon: mdi:thermometer
  
  fussboden_max_stufe:
    name: Maximale Ventilöffnungs-Stufe
    options:
      - "Aus"
      - "1"
      - "2"
      - "3"
      - "4"
      - "5"
    initial: "5"
    icon: mdi:valve

# ========================================
# Template Sensor
# ========================================
template:
  - sensor:
      - name: "Max Ventilöffnung Prozent"
        unique_id: max_valve_opening_percent
        unit_of_measurement: "%"
        icon: mdi:valve
        state: >
          {% set stufe = states('input_select.fussboden_max_stufe') %}
          {% if stufe == 'Aus' %}
            0
          {% elif stufe == '1' %}
            17
          {% elif stufe == '2' %}
            33
          {% elif stufe == '3' %}
            50
          {% elif stufe == '4' %}
            67
          {% elif stufe == '5' %}
            83
          {% else %}
            83
          {% endif %}

# ========================================
# Generic Thermostat (Virtuelle Thermostate)
# ========================================
climate:
  # BAD
  - platform: generic_thermostat
    name: Fußboden Bad HK
    unique_id: fussboden_thermostat_bad_hk
    heater: switch.fussboden_heater_bad_dummy
    target_sensor: sensor.temperatur_badezimmer_temperature
    min_temp: 6
    max_temp: 28
    target_temp: 20
    cold_tolerance: 0.3
    hot_tolerance: 0.3
    min_cycle_duration:
      minutes: 5
    initial_hvac_mode: "heat"
  
  # BÜRO
  - platform: generic_thermostat
    name: Fußboden Büro HK
    unique_id: fussboden_thermostat_buro_hk
    heater: switch.fussboden_heater_buro_dummy
    target_sensor: sensor.sbht_003c_a7e0_temperature
    min_temp: 6
    max_temp: 28
    target_temp: 20
    cold_tolerance: 0.3
    hot_tolerance: 0.3
    min_cycle_duration:
      minutes: 5
    initial_hvac_mode: "heat"
  
  # FLUR
  - platform: generic_thermostat
    name: Fußboden Flur HK
    unique_id: fussboden_thermostat_flur_hk
    heater: switch.fussboden_heater_flur_dummy
    target_sensor: sensor.indoor_outdoor_meter_280f
    min_temp: 6
    max_temp: 28
    target_temp: 20
    cold_tolerance: 0.3
    hot_tolerance: 0.3
    min_cycle_duration:
      minutes: 5
    initial_hvac_mode: "heat"
  
  # KÜCHE
  - platform: generic_thermostat
    name: Fußboden Küche HK
    unique_id: fussboden_thermostat_kuche_hk
    heater: switch.fussboden_heater_kuche_dummy
    target_sensor: sensor.temp_wohnzimmer_sb
    min_temp: 6
    max_temp: 28
    target_temp: 20
    cold_tolerance: 0.3
    hot_tolerance: 0.3
    min_cycle_duration:
      minutes: 5
    initial_hvac_mode: "heat"
  
  # SCHLAFZIMMER
  - platform: generic_thermostat
    name: Fußboden Schlafzimmer HK
    unique_id: fussboden_thermostat_schlafzimmer_hk
    heater: switch.fussboden_heater_schlafzimmer_dummy
    target_sensor: sensor.temperatur_schlaf_temperature
    min_temp: 6
    max_temp: 28
    target_temp: 20
    cold_tolerance: 0.3
    hot_tolerance: 0.3
    min_cycle_duration:
      minutes: 5
    initial_hvac_mode: "heat"
  
  # WOHNZIMMER
  - platform: generic_thermostat
    name: Fußboden Wohnzimmer HK
    unique_id: fussboden_thermostat_wohnzimmer_hk
    heater: switch.fussboden_heater_wohnzimmer_dummy
    target_sensor: sensor.temp_wohnzimmer_sb
    min_temp: 6
    max_temp: 28
    target_temp: 20
    cold_tolerance: 0.3
    hot_tolerance: 0.3
    min_cycle_duration:
      minutes: 5
    initial_hvac_mode: "heat"

# ========================================
# Dummy Switches für Generic Thermostats
# ========================================
switch:
  - platform: template
    switches:
      fussboden_heater_bad_dummy:
        unique_id: fussboden_heater_bad_dummy
        friendly_name: "Fußboden Bad Heater"
        value_template: "{{ states('input_boolean.fussboden_bad_heating') }}"
        turn_on:
          service: input_boolean.turn_on
          target:
            entity_id: input_boolean.fussboden_bad_heating
        turn_off:
          service: input_boolean.turn_off
          target:
            entity_id: input_boolean.fussboden_bad_heating
      
      fussboden_heater_buro_dummy:
        unique_id: fussboden_heater_buro_dummy
        friendly_name: "Fußboden Büro Heater"
        value_template: "{{ states('input_boolean.fussboden_buro_heating') }}"
        turn_on:
          service: input_boolean.turn_on
          target:
            entity_id: input_boolean.fussboden_buro_heating
        turn_off:
          service: input_boolean.turn_off
          target:
            entity_id: input_boolean.fussboden_buro_heating
      
      fussboden_heater_flur_dummy:
        unique_id: fussboden_heater_flur_dummy
        friendly_name: "Fußboden Flur Heater"
        value_template: "{{ states('input_boolean.fussboden_flur_heating') }}"
        turn_on:
          service: input_boolean.turn_on
          target:
            entity_id: input_boolean.fussboden_flur_heating
        turn_off:
          service: input_boolean.turn_off
          target:
            entity_id: input_boolean.fussboden_flur_heating
      
      fussboden_heater_kuche_dummy:
        unique_id: fussboden_heater_kuche_dummy
        friendly_name: "Fußboden Küche Heater"
        value_template: "{{ states('input_boolean.fussboden_kuche_heating') }}"
        turn_on:
          service: input_boolean.turn_on
          target:
            entity_id: input_boolean.fussboden_kuche_heating
        turn_off:
          service: input_boolean.turn_off
          target:
            entity_id: input_boolean.fussboden_kuche_heating
      
      fussboden_heater_schlafzimmer_dummy:
        unique_id: fussboden_heater_schlafzimmer_dummy
        friendly_name: "Fußboden Schlafzimmer Heater"
        value_template: "{{ states('input_boolean.fussboden_schlafzimmer_heating') }}"
        turn_on:
          service: input_boolean.turn_on
          target:
            entity_id: input_boolean.fussboden_schlafzimmer_heating
        turn_off:
          service: input_boolean.turn_off
          target:
            entity_id: input_boolean.fussboden_schlafzimmer_heating
      
      fussboden_heater_wohnzimmer_dummy:
        unique_id: fussboden_heater_wohnzimmer_dummy
        friendly_name: "Fußboden Wohnzimmer Heater"
        value_template: "{{ states('input_boolean.fussboden_wohnzimmer_heating') }}"
        turn_on:
          service: input_boolean.turn_on
          target:
            entity_id: input_boolean.fussboden_wohnzimmer_heating
        turn_off:
          service: input_boolean.turn_off
          target:
            entity_id: input_boolean.fussboden_wohnzimmer_heating

# ========================================
# Automations
# ========================================
automation:
  # ==================== BAD ====================
  - id: fussboden_thermostat_valve_control_bad
    alias: "Fußbodenheizung - Bad"
    description: "Ventilsteuerung für Bad mit Durchflussbegrenzung und Zeitsteuerung"
    
    trigger:
      - platform: state
        entity_id: climate.fussboden_bad_hk
        attribute: temperature
        for:
          seconds: 30
      - platform: state
        entity_id: climate.fussboden_bad_hk
        attribute: current_temperature
        for:
          minutes: 5
      - platform: state
        entity_id: sensor.temperatur_badezimmer_temperature
        for:
          minutes: 5
      - platform: state
        entity_id: input_select.fussboden_max_stufe
      - platform: state
        entity_id: input_boolean.fussboden_bad_heating
      - platform: time_pattern
        minutes: "/15"
    
    condition:
      - condition: and
        conditions:
          - condition: not
            conditions:
              - condition: state
                entity_id: climate.fussboden_bad_hk
                state: "off"
          - condition: or
            conditions:
              - condition: state
                entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                state: "off"
              - condition: and
                conditions:
                  - condition: state
                    entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                    state: "on"
                  - condition: template
                    value_template: >
                      {% set current = now().strftime('%H:%M') %}
                      {% set start = states('input_datetime.fussboden_start_zeit')[:5] %}
                      {% set ende = states('input_datetime.fussboden_ende_zeit')[:5] %}
                      {% if start < ende %}
                        {{ start <= current < ende }}
                      {% else %}
                        {{ current >= start or current < ende }}
                      {% endif %}
    
    action:
      - variables:
          solltemperatur: >
            {{ state_attr('climate.fussboden_bad_hk', 'temperature') | float(20) }}
          isttemperatur: >
            {{ states('sensor.temperatur_badezimmer_temperature') | float(20) }}
          hysterese: >
            {{ states('input_number.fussboden_hysterese') | float(1.0) }}
          max_stufe: >
            {{ states('sensor.max_ventiloffnung_prozent') | int(83) }}
          heater_on: >
            {{ is_state('input_boolean.fussboden_bad_heating', 'on') }}
          finale_oeffnung: >
            {% if not heater_on %}
              0
            {% elif isttemperatur >= solltemperatur %}
              0
            {% elif isttemperatur < (solltemperatur - hysterese) %}
              {{ max_stufe }}
            {% else %}
              0
            {% endif %}
          finale_closing: >
            {{ 100 - finale_oeffnung }}
      
      - service: number.set_value
        target:
          entity_id: number.heizung_bad_fussboden_valve_closing_degree
        data:
          value: "{{ finale_closing }}"

  # ==================== BÜRO ====================
  - id: fussboden_thermostat_valve_control_buro
    alias: "Fußbodenheizung - Büro"
    description: "Ventilsteuerung für Büro mit Durchflussbegrenzung und Zeitsteuerung"
    
    trigger:
      - platform: state
        entity_id: climate.fussboden_buro_hk
        attribute: temperature
        for:
          seconds: 30
      - platform: state
        entity_id: climate.fussboden_buro_hk
        attribute: current_temperature
        for:
          minutes: 5
      - platform: state
        entity_id: sensor.sbht_003c_a7e0_temperature
        for:
          minutes: 5
      - platform: state
        entity_id: input_select.fussboden_max_stufe
      - platform: state
        entity_id: input_boolean.fussboden_buro_heating
      - platform: time_pattern
        minutes: "/15"
    
    condition:
      - condition: and
        conditions:
          - condition: not
            conditions:
              - condition: state
                entity_id: climate.fussboden_buro_hk
                state: "off"
          - condition: or
            conditions:
              - condition: state
                entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                state: "off"
              - condition: and
                conditions:
                  - condition: state
                    entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                    state: "on"
                  - condition: template
                    value_template: >
                      {% set current = now().strftime('%H:%M') %}
                      {% set start = states('input_datetime.fussboden_start_zeit')[:5] %}
                      {% set ende = states('input_datetime.fussboden_ende_zeit')[:5] %}
                      {% if start < ende %}
                        {{ start <= current < ende }}
                      {% else %}
                        {{ current >= start or current < ende }}
                      {% endif %}
    
    action:
      - variables:
          solltemperatur: >
            {{ state_attr('climate.fussboden_buro_hk', 'temperature') | float(20) }}
          isttemperatur: >
            {{ states('sensor.sbht_003c_a7e0_temperature') | float(20) }}
          hysterese: >
            {{ states('input_number.fussboden_hysterese') | float(1.0) }}
          max_stufe: >
            {{ states('sensor.max_ventiloffnung_prozent') | int(83) }}
          heater_on: >
            {{ is_state('input_boolean.fussboden_buro_heating', 'on') }}
          finale_oeffnung: >
            {% if not heater_on %}
              0
            {% elif isttemperatur >= solltemperatur %}
              0
            {% elif isttemperatur < (solltemperatur - hysterese) %}
              {{ max_stufe }}
            {% else %}
              0
            {% endif %}
          finale_closing: >
            {{ 100 - finale_oeffnung }}
      
      - service: number.set_value
        target:
          entity_id: number.heizung_buro_fussboden_valve_closing_degree
        data:
          value: "{{ finale_closing }}"

  # ==================== FLUR ====================
  - id: fussboden_thermostat_valve_control_flur
    alias: "Fußbodenheizung - Flur"
    description: "Ventilsteuerung für Flur mit Durchflussbegrenzung und Zeitsteuerung"
    
    trigger:
      - platform: state
        entity_id: climate.fussboden_flur_hk
        attribute: temperature
        for:
          seconds: 30
      - platform: state
        entity_id: climate.fussboden_flur_hk
        attribute: current_temperature
        for:
          minutes: 5
      - platform: state
        entity_id: sensor.indoor_outdoor_meter_280f
        for:
          minutes: 5
      - platform: state
        entity_id: input_select.fussboden_max_stufe
      - platform: state
        entity_id: input_boolean.fussboden_flur_heating
      - platform: time_pattern
        minutes: "/15"
    
    condition:
      - condition: and
        conditions:
          - condition: not
            conditions:
              - condition: state
                entity_id: climate.fussboden_flur_hk
                state: "off"
          - condition: or
            conditions:
              - condition: state
                entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                state: "off"
              - condition: and
                conditions:
                  - condition: state
                    entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                    state: "on"
                  - condition: template
                    value_template: >
                      {% set current = now().strftime('%H:%M') %}
                      {% set start = states('input_datetime.fussboden_start_zeit')[:5] %}
                      {% set ende = states('input_datetime.fussboden_ende_zeit')[:5] %}
                      {% if start < ende %}
                        {{ start <= current < ende }}
                      {% else %}
                        {{ current >= start or current < ende }}
                      {% endif %}
    
    action:
      - variables:
          solltemperatur: >
            {{ state_attr('climate.fussboden_flur_hk', 'temperature') | float(20) }}
          isttemperatur: >
            {{ states('sensor.indoor_outdoor_meter_280f') | float(20) }}
          hysterese: >
            {{ states('input_number.fussboden_hysterese') | float(1.0) }}
          max_stufe: >
            {{ states('sensor.max_ventiloffnung_prozent') | int(83) }}
          heater_on: >
            {{ is_state('input_boolean.fussboden_flur_heating', 'on') }}
          finale_oeffnung: >
            {% if not heater_on %}
              0
            {% elif isttemperatur >= solltemperatur %}
              0
            {% elif isttemperatur < (solltemperatur - hysterese) %}
              {{ max_stufe }}
            {% else %}
              0
            {% endif %}
          finale_closing: >
            {{ 100 - finale_oeffnung }}
      
      - service: number.set_value
        target:
          entity_id: number.heizung_flur_fussboden_valve_closing_degree
        data:
          value: "{{ finale_closing }}"

  # ==================== KÜCHE ====================
  - id: fussboden_thermostat_valve_control_kuche
    alias: "Fußbodenheizung - Küche"
    description: "Ventilsteuerung für Küche mit Durchflussbegrenzung und Zeitsteuerung"
    
    trigger:
      - platform: state
        entity_id: climate.fussboden_kuche_hk
        attribute: temperature
        for:
          seconds: 30
      - platform: state
        entity_id: climate.fussboden_kuche_hk
        attribute: current_temperature
        for:
          minutes: 5
      - platform: state
        entity_id: sensor.temp_wohnzimmer_sb
        for:
          minutes: 5
      - platform: state
        entity_id: input_select.fussboden_max_stufe
      - platform: state
        entity_id: input_boolean.fussboden_kuche_heating
      - platform: time_pattern
        minutes: "/15"
    
    condition:
      - condition: and
        conditions:
          - condition: not
            conditions:
              - condition: state
                entity_id: climate.fussboden_kuche_hk
                state: "off"
          - condition: or
            conditions:
              - condition: state
                entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                state: "off"
              - condition: and
                conditions:
                  - condition: state
                    entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                    state: "on"
                  - condition: template
                    value_template: >
                      {% set current = now().strftime('%H:%M') %}
                      {% set start = states('input_datetime.fussboden_start_zeit')[:5] %}
                      {% set ende = states('input_datetime.fussboden_ende_zeit')[:5] %}
                      {% if start < ende %}
                        {{ start <= current < ende }}
                      {% else %}
                        {{ current >= start or current < ende }}
                      {% endif %}
    
    action:
      - variables:
          solltemperatur: >
            {{ state_attr('climate.fussboden_kuche_hk', 'temperature') | float(20) }}
          isttemperatur: >
            {{ states('sensor.temp_wohnzimmer_sb') | float(20) }}
          hysterese: >
            {{ states('input_number.fussboden_hysterese') | float(1.0) }}
          max_stufe: >
            {{ states('sensor.max_ventiloffnung_prozent') | int(83) }}
          heater_on: >
            {{ is_state('input_boolean.fussboden_kuche_heating', 'on') }}
          finale_oeffnung: >
            {% if not heater_on %}
              0
            {% elif isttemperatur >= solltemperatur %}
              0
            {% elif isttemperatur < (solltemperatur - hysterese) %}
              {{ max_stufe }}
            {% else %}
              0
            {% endif %}
          finale_closing: >
            {{ 100 - finale_oeffnung }}
      
      - service: number.set_value
        target:
          entity_id: number.heizung_kuche_fussboden_valve_closing_degree
        data:
          value: "{{ finale_closing }}"

  # ==================== SCHLAFZIMMER ====================
  - id: fussboden_thermostat_valve_control_schlafzimmer
    alias: "Fußbodenheizung - Schlafzimmer"
    description: "Ventilsteuerung für Schlafzimmer mit Durchflussbegrenzung und Zeitsteuerung"
    
    trigger:
      - platform: state
        entity_id: climate.fussboden_schlafzimmer_hk
        attribute: temperature
        for:
          seconds: 30
      - platform: state
        entity_id: climate.fussboden_schlafzimmer_hk
        attribute: current_temperature
        for:
          minutes: 5
      - platform: state
        entity_id: sensor.temperatur_schlaf_temperature
        for:
          minutes: 5
      - platform: state
        entity_id: input_select.fussboden_max_stufe
      - platform: state
        entity_id: input_boolean.fussboden_schlafzimmer_heating
      - platform: time_pattern
        minutes: "/15"
    
    condition:
      - condition: and
        conditions:
          - condition: not
            conditions:
              - condition: state
                entity_id: climate.fussboden_schlafzimmer_hk
                state: "off"
          - condition: or
            conditions:
              - condition: state
                entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                state: "off"
              - condition: and
                conditions:
                  - condition: state
                    entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                    state: "on"
                  - condition: template
                    value_template: >
                      {% set current = now().strftime('%H:%M') %}
                      {% set start = states('input_datetime.fussboden_start_zeit')[:5] %}
                      {% set ende = states('input_datetime.fussboden_ende_zeit')[:5] %}
                      {% if start < ende %}
                        {{ start <= current < ende }}
                      {% else %}
                        {{ current >= start or current < ende }}
                      {% endif %}
    
    action:
      - variables:
          solltemperatur: >
            {{ state_attr('climate.fussboden_schlafzimmer_hk', 'temperature') | float(20) }}
          isttemperatur: >
            {{ states('sensor.temperatur_schlaf_temperature') | float(20) }}
          hysterese: >
            {{ states('input_number.fussboden_hysterese') | float(1.0) }}
          max_stufe: >
            {{ states('sensor.max_ventiloffnung_prozent') | int(83) }}
          heater_on: >
            {{ is_state('input_boolean.fussboden_schlafzimmer_heating', 'on') }}
          finale_oeffnung: >
            {% if not heater_on %}
              0
            {% elif isttemperatur >= solltemperatur %}
              0
            {% elif isttemperatur < (solltemperatur - hysterese) %}
              {{ max_stufe }}
            {% else %}
              0
            {% endif %}
          finale_closing: >
            {{ 100 - finale_oeffnung }}
      
      - service: number.set_value
        target:
          entity_id: number.heizung_schlafzimmer_fussboden_valve_closing_degree
        data:
          value: "{{ finale_closing }}"

  # ==================== WOHNZIMMER ====================
  - id: fussboden_thermostat_valve_control_wohnzimmer
    alias: "Fußbodenheizung - Wohnzimmer"
    description: "Ventilsteuerung für Wohnzimmer mit Durchflussbegrenzung und Zeitsteuerung"
    
    trigger:
      - platform: state
        entity_id: climate.fussboden_wohnzimmer_hk
        attribute: temperature
        for:
          seconds: 30
      - platform: state
        entity_id: climate.fussboden_wohnzimmer_hk
        attribute: current_temperature
        for:
          minutes: 5
      - platform: state
        entity_id: sensor.temp_wohnzimmer_sb
        for:
          minutes: 5
      - platform: state
        entity_id: input_select.fussboden_max_stufe
      - platform: state
        entity_id: input_boolean.fussboden_wohnzimmer_heating
      - platform: time_pattern
        minutes: "/15"
    
    condition:
      - condition: and
        conditions:
          - condition: not
            conditions:
              - condition: state
                entity_id: climate.fussboden_wohnzimmer_hk
                state: "off"
          - condition: or
            conditions:
              - condition: state
                entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                state: "off"
              - condition: and
                conditions:
                  - condition: state
                    entity_id: input_boolean.fussboden_zeitsteuerung_aktiv
                    state: "on"
                  - condition: template
                    value_template: >
                      {% set current = now().strftime('%H:%M') %}
                      {% set start = states('input_datetime.fussboden_start_zeit')[:5] %}
                      {% set ende = states('input_datetime.fussboden_ende_zeit')[:5] %}
                      {% if start < ende %}
                        {{ start <= current < ende }}
                      {% else %}
                        {{ current >= start or current < ende }}
                      {% endif %}
    
    action:
      - variables:
          solltemperatur: >
            {{ state_attr('climate.fussboden_wohnzimmer_hk', 'temperature') | float(20) }}
          isttemperatur: >
            {{ states('sensor.temp_wohnzimmer_sb') | float(20) }}
          hysterese: >
            {{ states('input_number.fussboden_hysterese') | float(1.0) }}
          max_stufe: >
            {{ states('sensor.max_ventiloffnung_prozent') | int(83) }}
          heater_on: >
            {{ is_state('input_boolean.fussboden_wohnzimmer_heating', 'on') }}
          finale_oeffnung: >
            {% if not heater_on %}
              0
            {% elif isttemperatur >= solltemperatur %}
              0
            {% elif isttemperatur < (solltemperatur - hysterese) %}
              {{ max_stufe }}
            {% else %}
              0
            {% endif %}
          finale_closing: >
            {{ 100 - finale_oeffnung }}
      
      - service: number.set_value
        target:
          entity_id: number.heizung_wohnzimmer_fussboden_valve_closing_degree
        data:
          value: "{{ finale_closing }}"

  # ==================== SYNC: THERMOSTAT → INPUT NUMBER ====================
  # Bad
  - id: fussboden_sync_thermostat_to_input_bad
    alias: "Fußbodenheizung - Sync Thermostat zu Input (Bad)"
    trigger:
      - platform: state
        entity_id: climate.fussboden_bad_hk
        attribute: temperature
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.fussboden_bad_solltemperatur
        data:
          value: "{{ state_attr('climate.fussboden_bad_hk', 'temperature') }}"
  
  # Büro
  - id: fussboden_sync_thermostat_to_input_buro
    alias: "Fußbodenheizung - Sync Thermostat zu Input (Büro)"
    trigger:
      - platform: state
        entity_id: climate.fussboden_buro_hk
        attribute: temperature
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.fussboden_buro_solltemperatur
        data:
          value: "{{ state_attr('climate.fussboden_buro_hk', 'temperature') }}"
  
  # Flur
  - id: fussboden_sync_thermostat_to_input_flur
    alias: "Fußbodenheizung - Sync Thermostat zu Input (Flur)"
    trigger:
      - platform: state
        entity_id: climate.fussboden_flur_hk
        attribute: temperature
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.fussboden_flur_solltemperatur
        data:
          value: "{{ state_attr('climate.fussboden_flur_hk', 'temperature') }}"
  
  # Küche
  - id: fussboden_sync_thermostat_to_input_kuche
    alias: "Fußbodenheizung - Sync Thermostat zu Input (Küche)"
    trigger:
      - platform: state
        entity_id: climate.fussboden_kuche_hk
        attribute: temperature
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.fussboden_kuche_solltemperatur
        data:
          value: "{{ state_attr('climate.fussboden_kuche_hk', 'temperature') }}"
  
  # Schlafzimmer
  - id: fussboden_sync_thermostat_to_input_schlafzimmer
    alias: "Fußbodenheizung - Sync Thermostat zu Input (Schlafzimmer)"
    trigger:
      - platform: state
        entity_id: climate.fussboden_schlafzimmer_hk
        attribute: temperature
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.fussboden_schlafzimmer_solltemperatur
        data:
          value: "{{ state_attr('climate.fussboden_schlafzimmer_hk', 'temperature') }}"
  
  # Wohnzimmer
  - id: fussboden_sync_thermostat_to_input_wohnzimmer
    alias: "Fußbodenheizung - Sync Thermostat zu Input (Wohnzimmer)"
    trigger:
      - platform: state
        entity_id: climate.fussboden_wohnzimmer_hk
        attribute: temperature
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.fussboden_wohnzimmer_solltemperatur
        data:
          value: "{{ state_attr('climate.fussboden_wohnzimmer_hk', 'temperature') }}"

  # ==================== SYNC: INPUT NUMBER → THERMOSTAT ====================
  # Bad
  - id: fussboden_sync_input_to_thermostat_bad
    alias: "Fußbodenheizung - Sync Input zu Thermostat (Bad)"
    trigger:
      - platform: state
        entity_id: input_number.fussboden_bad_solltemperatur
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.fussboden_bad_hk
        data:
          temperature: "{{ states('input_number.fussboden_bad_solltemperatur') | float }}"
  
  # Büro
  - id: fussboden_sync_input_to_thermostat_buro
    alias: "Fußbodenheizung - Sync Input zu Thermostat (Büro)"
    trigger:
      - platform: state
        entity_id: input_number.fussboden_buro_solltemperatur
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.fussboden_buro_hk
        data:
          temperature: "{{ states('input_number.fussboden_buro_solltemperatur') | float }}"
  
  # Flur
  - id: fussboden_sync_input_to_thermostat_flur
    alias: "Fußbodenheizung - Sync Input zu Thermostat (Flur)"
    trigger:
      - platform: state
        entity_id: input_number.fussboden_flur_solltemperatur
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.fussboden_flur_hk
        data:
          temperature: "{{ states('input_number.fussboden_flur_solltemperatur') | float }}"
  
  # Küche
  - id: fussboden_sync_input_to_thermostat_kuche
    alias: "Fußbodenheizung - Sync Input zu Thermostat (Küche)"
    trigger:
      - platform: state
        entity_id: input_number.fussboden_kuche_solltemperatur
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.fussboden_kuche_hk
        data:
          temperature: "{{ states('input_number.fussboden_kuche_solltemperatur') | float }}"
  
  # Schlafzimmer
  - id: fussboden_sync_input_to_thermostat_schlafzimmer
    alias: "Fußbodenheizung - Sync Input zu Thermostat (Schlafzimmer)"
    trigger:
      - platform: state
        entity_id: input_number.fussboden_schlafzimmer_solltemperatur
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.fussboden_schlafzimmer_hk
        data:
          temperature: "{{ states('input_number.fussboden_schlafzimmer_solltemperatur') | float }}"
  
  # Wohnzimmer
  - id: fussboden_sync_input_to_thermostat_wohnzimmer
    alias: "Fußbodenheizung - Sync Input zu Thermostat (Wohnzimmer)"
    trigger:
      - platform: state
        entity_id: input_number.fussboden_wohnzimmer_solltemperatur
    action:
      - service: climate.set_temperature
        target:
          entity_id: climate.fussboden_wohnzimmer_hk
        data:
          temperature: "{{ states('input_number.fussboden_wohnzimmer_solltemperatur') | float }}"

  # ==================== WARNUNG BEI HOHEM DRUCK ====================
  - id: fussboden_druck_warnung
    alias: "Fußbodenheizung - Druckwarnung"
    description: "Benachrichtigung bei zu hohem Systemdruck"
    
    trigger:
      - platform: numeric_state
        entity_id: input_number.fussbodenheizung_druck
        above: 50
    
    action:
      - service: persistent_notification.create
        data:
          title: "⚠️ Hoher Heizungsdruck"
          message: >
            Der Fußbodenheizungs-Druck liegt bei 
            {{ states('input_number.fussbodenheizung_druck') }} kPa.
            Die Ventilöffnung wird stark begrenzt (max. 30%).
            Bitte Systemdruck prüfen!

  # ==================== ANTI-VERKALKUNG (Multi HK Eclipse) ====================
  - id: fussboden_anti_verkalkung
    alias: "Fußbodenheizung - Anti-Verkalkung"
    description: "Wöchentliche Ventil-Durchspülung zur Vermeidung von Verkalkung"
    
    trigger:
      - platform: time
        at: "03:00:00"
    
    condition:
      - condition: state
        entity_id: input_boolean.fussboden_anti_verkalkung_aktiv
        state: "on"
      - condition: template
        value_template: "{{ now().weekday() == 6 }}"  # Sonntag
    
    action:
      # Schritt 1: Alle Ventile auf 100% öffnen (closing_degree = 0)
      - service: number.set_value
        target:
          entity_id:
            - number.heizung_bad_fussboden_valve_closing_degree
            - number.heizung_buro_fussboden_valve_closing_degree
            - number.heizung_flur_fussboden_valve_closing_degree
            - number.heizung_kuche_fussboden_valve_closing_degree
            - number.heizung_schlafzimmer_fussboden_valve_closing_degree
            - number.heizung_wohnzimmer_fussboden_valve_closing_degree
        data:
          value: 0
      
      # 5 Minuten warten
      - delay:
          minutes: 5
      
      # Schritt 2: Alle Ventile auf 0% öffnen (closing_degree = 100)
      - service: number.set_value
        target:
          entity_id:
            - number.heizung_bad_fussboden_valve_closing_degree
            - number.heizung_buro_fussboden_valve_closing_degree
            - number.heizung_flur_fussboden_valve_closing_degree
            - number.heizung_kuche_fussboden_valve_closing_degree
            - number.heizung_schlafzimmer_fussboden_valve_closing_degree
            - number.heizung_wohnzimmer_fussboden_valve_closing_degree
        data:
          value: 100
      
      # 5 Minuten warten
      - delay:
          minutes: 5
      
      # Benachrichtigung
      - service: persistent_notification.create
        data:
          title: "✅ Anti-Verkalkung abgeschlossen"
          message: >
            Die wöchentliche Ventil-Durchspülung wurde erfolgreich durchgeführt.
            Alle Ventile wurden 5 Min auf 100% und 5 Min auf 0% gesetzt.
            Das System wird nun wieder normal gesteuert.

# ========================================
# Scripts für Szenen und Gruppen
# ========================================
script:
  # ==================== SZENE: KOMFORT ====================
  fussboden_szene_komfort:
    alias: "Fußbodenheizung - Komfort-Modus"
    icon: mdi:sofa
    sequence:
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.fussboden_bad_solltemperatur
            - input_number.fussboden_buro_solltemperatur
            - input_number.fussboden_flur_solltemperatur
            - input_number.fussboden_kuche_solltemperatur
            - input_number.fussboden_schlafzimmer_solltemperatur
            - input_number.fussboden_wohnzimmer_solltemperatur
        data:
          value: 22

  # ==================== SZENE: ECO ====================
  fussboden_szene_eco:
    alias: "Fußbodenheizung - Eco-Modus"
    icon: mdi:leaf
    sequence:
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.fussboden_bad_solltemperatur
            - input_number.fussboden_buro_solltemperatur
            - input_number.fussboden_flur_solltemperatur
            - input_number.fussboden_kuche_solltemperatur
            - input_number.fussboden_schlafzimmer_solltemperatur
            - input_number.fussboden_wohnzimmer_solltemperatur
        data:
          value: 18

  # ==================== SZENE: NACHT ====================
  fussboden_szene_nacht:
    alias: "Fußbodenheizung - Nacht-Modus"
    icon: mdi:weather-night
    sequence:
      - service: input_number.set_value
        target:
          entity_id: input_number.fussboden_schlafzimmer_solltemperatur
        data:
          value: 18
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.fussboden_bad_solltemperatur
            - input_number.fussboden_buro_solltemperatur
            - input_number.fussboden_flur_solltemperatur
            - input_number.fussboden_kuche_solltemperatur
            - input_number.fussboden_wohnzimmer_solltemperatur
        data:
          value: 16

  # ==================== SZENE: AUS ====================
  fussboden_szene_aus:
    alias: "Fußbodenheizung - Alle Aus"
    icon: mdi:power
    sequence:
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.fussboden_bad_solltemperatur
            - input_number.fussboden_buro_solltemperatur
            - input_number.fussboden_flur_solltemperatur
            - input_number.fussboden_kuche_solltemperatur
            - input_number.fussboden_schlafzimmer_solltemperatur
            - input_number.fussboden_wohnzimmer_solltemperatur
        data:
          value: 6

  # ==================== GRUPPE: WOHNBEREICH ====================
  fussboden_gruppe_wohnbereich:
    alias: "Fußbodenheizung - Wohnbereich synchronisieren"
    icon: mdi:home-group
    sequence:
      - variables:
          zieltemperatur: "{{ states('input_number.fussboden_wohnzimmer_solltemperatur') | float }}"
      - service: input_number.set_value
        target:
          entity_id:
            - input_number.fussboden_kuche_solltemperatur
            - input_number.fussboden_flur_solltemperatur
        data:
          value: "{{ zieltemperatur }}"

  # ==================== GRUPPE: SCHLAFBEREICH ====================
  fussboden_gruppe_schlafbereich:
    alias: "Fußbodenheizung - Schlafbereich synchronisieren"
    icon: mdi:bed
    sequence:
      - variables:
          zieltemperatur: "{{ states('input_number.fussboden_schlafzimmer_solltemperatur') | float }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.fussboden_bad_solltemperatur
        data:
          value: "{{ zieltemperatur }}"
